<!doctype html>
<html lang="en">
<head>
 
<link rel="stylesheet" href="/style.css">
<script type="module" src="/dashboard-auth.js"></script>
<script type="module" src="/supabase-client.js"></script>
<script src="/script.js"></script>

 <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Botnology 101 â€¢ Dashboard</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* minimal safety styling if style.css missing */
    body{margin:0;font-family:Arial,system-ui;background:#0f1f17;color:#e6f2ec}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .pill{border:1px solid rgba(230,242,236,.16);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
    .card{border:1px solid rgba(230,242,236,.12);border-radius:16px;background:rgba(255,255,255,.03);box-shadow:0 12px 36px rgba(0,0,0,.25)}
    .card .in{padding:14px}
    .btn{border:1px solid rgba(230,242,236,.18);background:rgba(255,255,255,.04);color:#e6f2ec;padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:rgba(191,230,208,.12);border-color:rgba(191,230,208,.22)}
    .btn.secondary{opacity:.9}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .input{flex:1;min-width:220px;border-radius:12px;border:1px solid rgba(230,242,236,.14);background:rgba(0,0,0,.22);color:#e6f2ec;padding:10px 12px;outline:none}
    .muted{opacity:.75}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <!-- Supabase config (OPTIONAL override; normally use ENV inside supabase-client.js) -->
  <script>
    // If you want: paste values here. Otherwise supabase-client.js can read from window vars.
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || "";
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || "";
  </script>

  <div class="wrap">
    <div class="top">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:46px;height:46px;border-radius:999px;border:1px solid rgba(191,230,208,.22);background:#13261d;display:flex;align-items:center;justify-content:center;font-weight:900;">B</div>
        <div>
          <div style="font-weight:950;letter-spacing:.2px;font-size:16px;">Student Dashboard</div>
          <div class="muted" style="font-size:12px;">Botnology 101 â€¢ Dr. Botonic</div>
        </div>
      </div>
      <div class="row">
        <div id="planPill" class="pill">PLAN: â€”</div>
        <div id="apiPill" class="pill muted">API: â€¦</div>
        <button id="btnLogout" class="btn secondary" type="button">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="in">
          <div id="heroTitle" style="font-size:22px;font-weight:950; margin-bottom:8px;">Welcome.</div>
          <div class="muted" id="checkoutHint" style="margin-bottom:12px;"></div>

          <div class="row" style="margin-bottom:12px;">
            <button id="btnStart" class="btn primary" type="button">Start Tutor Session</button>
            <button id="btnResume" class="btn secondary" type="button">Resume Session</button>
            <button id="btnNewProject" class="btn secondary" type="button">New Project</button>
            <button id="btnOpenWorkspace" class="btn secondary" type="button">Open Workspace</button>
          </div>

          <div class="row">
            <input id="quickPrompt" class="input" placeholder="Ask Dr. Botonic somethingâ€¦" />
            <button id="btnAsk" class="btn primary" type="button">Ask</button>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
            <button id="btnUpload" class="btn secondary" type="button">Upload Files</button>
            <button id="btnNewFolder" class="btn secondary" type="button">New Folder</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="in">
          <div style="display:flex;gap:12px;align-items:center;">
            <img id="botonicImg" src="/dr-botonic.png" alt="Dr. Botonic"
              style="width:64px;height:64px;border-radius:999px;object-fit:cover;border:1px solid rgba(191,230,208,.22);" />
            <div style="min-width:0;">
              <div style="font-weight:950;">Hi, <span id="studentName">Student</span></div>
              <div class="muted" style="font-size:12px;">Your workspace + tutor console.</div>
              <div class="muted" id="progressStamp" style="font-size:12px;margin-top:6px;"></div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="muted" style="font-size:12px;margin-bottom:6px;">Recommendations</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <button id="rec1" class="btn secondary" type="button">12-minute micro-session (diagnostic)</button>
              <button id="rec2" class="btn secondary" type="button">Adaptive anatomy quiz</button>
              <button id="rec3" class="btn secondary" type="button">Build a weekly plan</button>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="muted" style="font-size:12px;margin-bottom:6px;">API Status</div>
            <div class="pill" style="display:flex;align-items:center;justify-content:space-between;">
              <span id="apiStatusText" class="muted">Checkingâ€¦</span>
              <span class="muted" style="font-size:12px;">/api/health</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" style="display:none; position:fixed; right:14px; bottom:14px; z-index:80; max-width:420px;">
      <div style="border:1px solid rgba(230,242,236,.16); background:rgba(0,0,0,.55); backdrop-filter: blur(10px); border-radius:14px; padding:12px 12px;">
        <div id="toastTitle" style="font-weight:950; margin-bottom:4px;">Title</div>
        <div id="toastMsg" class="muted" style="font-size:13px; line-height:1.4;">Message</div>
      </div>
    </div>
  </div>

  <!-- Auth + Supabase -->
  <script type="module" src="/dashboard-auth.js"></script>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);

    function toast(title, msg){
      const t = $("toast");
      $("toastTitle").textContent = title;
      $("toastMsg").textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.style.display = "none", 3600);
    }
    function safeJson(raw){ try { return JSON.parse(raw); } catch { return null; } }
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function lsGet(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } }
    function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // ---- state ----
    const STATE_KEY = "bn_state_v1";
    function getState(){
      const base = lsGet(STATE_KEY, null);
      if(base) return base;
      return {
        studentName: (localStorage.getItem("bn_student_name") || "Student"),
        plan: "PRO",
        projects: [
          { id:"p1", name:"Anatomy â€” Unit 3 Review", status:"ACTIVE", updated:"yesterday" },
          { id:"p2", name:"Math â€” Fractions & Ratios", status:"DRAFT", updated:"2d ago" },
          { id:"p3", name:"Chemistry â€” Periodic Trends", status:"NEEDS LOVE", updated:"3d ago" }
        ],
        folders: [{ id:"f1", name:"Notes" }, { id:"f2", name:"Uploads" }, { id:"f3", name:"Quizzes" }],
        files: [],
        activeProjectId: "p1",
        activeFolderId: "f1"
      };
    }
    function setState(s){ lsSet(STATE_KEY, s); }
    function activeProject(s){ return s.projects.find(p=>p.id===s.activeProjectId) || null; }
    function activeFolder(s){ return s.folders.find(f=>f.id===s.activeFolderId) || null; }

    // ---- greeting ----
    const now = new Date();
    const hr = now.getHours();
    const greet = hr < 12 ? "Good morning" : hr < 18 ? "Good afternoon" : "Good evening";
    $("heroTitle").textContent = `${greet}. Ready to level up?`;
    $("progressStamp").textContent = "Updated " + now.toLocaleString(undefined, { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });

    // ---- URL checkout hint ----
    const params = new URLSearchParams(window.location.search);
    const checkout = params.get("checkout");
    if(checkout === "success"){
      $("checkoutHint").textContent = "Checkout confirmed. Workspace unlocked. ðŸš€";
      toast("Subscription activated", "Premium mode engaged.");
    } else if(checkout === "cancel"){
      $("checkoutHint").textContent = "Checkout canceled. Nothing charged.";
      toast("Checkout canceled", "Pick a plan when ready.");
    } else {
      $("checkoutHint").textContent = "Tip: Plan upgrades sync here once billing is wired.";
    }

    // ---- avatar fallback ----
    $("botonicImg")?.addEventListener("error", ()=>{
      $("botonicImg").src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
          <rect width="100%" height="100%" fill="rgba(191,230,208,.08)"/>
          <text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle"
            fill="rgba(230,242,236,.7)" font-family="Arial" font-size="14">Dr. Botonic</text>
        </svg>`
      );
    });

    // ---- auth token (set by dashboard-auth.js) ----
    function getAccessToken(){
      return window.__SUPABASE_ACCESS_TOKEN__ || localStorage.getItem("sb_access_token") || "";
    }

    // ---- API health ----
    async function checkAPI(){
      try{
        const r = await fetch("/api/health", { cache:"no-store" });
        if(!r.ok) throw new Error("HTTP " + r.status);
        await r.json();
        $("apiPill").textContent = "API: OK";
        $("apiPill").classList.remove("muted");
        $("apiStatusText").textContent = "Operational";
      }catch(e){
        $("apiPill").textContent = "API: DOWN";
        $("apiStatusText").textContent = "Degraded";
      }
    }
    checkAPI();

    // ---- tutor modal ----
    function ensureTutorModal(){
      if($("tutorModal")) return;

      const wrap = document.createElement("div");
      wrap.id = "tutorModal";
      wrap.style.cssText = "position:fixed; inset:0; display:none; z-index:60; background:rgba(0,0,0,.55); backdrop-filter: blur(8px); padding:14px;";
      wrap.innerHTML = `
        <div style="max-width:980px; margin:4vh auto; border:1px solid rgba(230,242,236,.12);
          border-radius:22px; background:rgba(10,18,13,.92); box-shadow: 0 22px 60px rgba(0,0,0,.55); overflow:hidden;">
          <div style="padding:14px 16px; border-bottom:1px solid rgba(230,242,236,.10); display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="font-weight:950; letter-spacing:.2px;">Tutor Session â€¢ Dr. Botonic</div>
            <div style="display:flex; gap:8px;">
              <button id="tutorClear" class="btn secondary" type="button">Clear</button>
              <button id="tutorClose" class="btn" type="button">Close</button>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 320px; gap:12px; padding:14px;">
            <div style="border:1px solid rgba(230,242,236,.10); border-radius:18px; background:rgba(255,255,255,.03); overflow:hidden;">
              <div id="tutorChat" style="height:52vh; overflow:auto; padding:12px;">
                <div style="opacity:.75; font-size:13px; line-height:1.45;">
                  Ask anything. Step-by-step. No fluff.
                </div>
              </div>
              <div style="border-top:1px solid rgba(230,242,236,.10); padding:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <input id="tutorInput" class="input" placeholder="Type your questionâ€¦" />
                <button id="tutorSend" class="btn primary" type="button">Send</button>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:12px;">
              <div style="border:1px solid rgba(230,242,236,.10); border-radius:18px; background:rgba(255,255,255,.03); padding:12px;">
                <div style="font-weight:950; font-size:13px; letter-spacing:.2px;">Session Context</div>
                <div style="margin-top:10px; font-size:12px; color:rgba(230,242,236,.70); line-height:1.4;">
                  <div><b>Project:</b> <span id="ctxProject">â€”</span></div>
                  <div style="margin-top:6px;"><b>Folder:</b> <span id="ctxFolder">â€”</span></div>
                </div>
              </div>

              <div style="border:1px solid rgba(230,242,236,.10); border-radius:18px; background:rgba(255,255,255,.03); padding:12px;">
                <div style="font-weight:950; font-size:13px; letter-spacing:.2px;">Quick Actions</div>
                <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
                  <button id="qaQuiz" class="btn secondary" type="button">Generate quick quiz</button>
                  <button id="qaPlan" class="btn secondary" type="button">Build a 7-day plan</button>
                  <button id="qaExplain" class="btn secondary" type="button">Explain like Iâ€™m 12</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(wrap);

      wrap.addEventListener("click",(e)=>{ if(e.target===wrap) closeTutor(); });
      $("tutorClose").addEventListener("click", closeTutor);

      $("tutorClear").addEventListener("click", ()=>{
        lsSet("bn_chat_history", []);
        $("tutorChat").innerHTML = `<div style="opacity:.75; font-size:13px; line-height:1.45;">Cleared. Ask anything.</div>`;
        toast("Session cleared", "Chat history cleared for this device.");
      });

      $("tutorSend").addEventListener("click", ()=> sendTutor());
      $("tutorInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendTutor(); });

      $("qaQuiz").addEventListener("click", ()=>{ $("tutorInput").value="Make me a quick quiz. Ask 5 calibration questions first."; $("tutorInput").focus(); });
      $("qaPlan").addEventListener("click", ()=>{ $("tutorInput").value="Build a 7-day study plan with 30â€“60 minute sessions."; $("tutorInput").focus(); });
      $("qaExplain").addEventListener("click", ()=>{
        const cur = $("tutorInput").value.trim();
        $("tutorInput").value = cur ? `Explain this like I'm 12: ${cur}` : "Explain the concept like I'm 12 with an example.";
        $("tutorInput").focus();
      });
    }

    function openTutor(){
      ensureTutorModal();
      $("tutorModal").style.display = "block";
      document.body.style.overflow = "hidden";
      syncContext();
      loadTutorHistory();
      setTimeout(()=> $("tutorInput").focus(), 50);
    }
    function closeTutor(){
      $("tutorModal").style.display = "none";
      document.body.style.overflow = "";
    }
    function syncContext(){
      const s = getState();
      $("ctxProject").textContent = (activeProject(s)?.name) || "â€”";
      $("ctxFolder").textContent = (activeFolder(s)?.name) || "â€”";
    }

    function renderChatMessage(role, text){
      const box = $("tutorChat");
      const row = document.createElement("div");
      row.style.margin = "10px 0";
      row.style.display = "flex";
      row.style.justifyContent = role==="user" ? "flex-end" : "flex-start";
      const bubble = document.createElement("div");
      bubble.style.maxWidth = "78%";
      bubble.style.padding = "10px 12px";
      bubble.style.borderRadius = "16px";
      bubble.style.border = "1px solid rgba(230,242,236,.10)";
      bubble.style.background = role==="user" ? "rgba(191,230,208,.10)" : "rgba(255,255,255,.03)";
      bubble.style.color = "rgba(230,242,236,.92)";
      bubble.style.fontSize = "13px";
      bubble.style.lineHeight = "1.45";
      bubble.textContent = text;
      row.appendChild(bubble);
      box.appendChild(row);
      box.scrollTop = box.scrollHeight;
    }

    function loadTutorHistory(){
      const hist = lsGet("bn_chat_history", []);
      const box = $("tutorChat");
      box.innerHTML = `<div style="opacity:.75; font-size:13px; line-height:1.45;">Ask anything. Step-by-step. No fluff.</div>`;
      hist.forEach(m => renderChatMessage(m.role, m.text));
      syncContext();
    }

    async function sendTutor(){
      const inp = $("tutorInput");
      const q = (inp.value||"").trim();
      if(!q) return;

      inp.value = "";
      renderChatMessage("user", q);

      const state = getState();
      const ctx = {
        project: activeProject(state)?.name || "",
        folder: activeFolder(state)?.name || "",
        plan: state.plan || "PRO"
      };

      // persist locally
      const hist = lsGet("bn_chat_history", []);
      hist.push({ role:"user", text:q, ts:Date.now(), ctx });
      lsSet("bn_chat_history", hist.slice(-60));

      // auth
      const token = getAccessToken();
      if(!token){
        renderChatMessage("assistant", "Youâ€™re not logged in. Sending you to /loginâ€¦");
        setTimeout(()=> window.location.href="/login", 800);
        return;
      }

      try{
        const res = await fetch("/api/chat", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + token
          },
          body: JSON.stringify({ message:q, context:ctx })
        });

        const raw = await res.text();
        const data = safeJson(raw) || { reply: raw };

        if(!res.ok){
          renderChatMessage("assistant", "Error: " + (data.detail || data.error || raw || "Request failed"));
          return;
        }

        const reply = (data.reply || data.message || "").toString().trim() || "No reply returned.";
        renderChatMessage("assistant", reply);

        const hist2 = lsGet("bn_chat_history", []);
        hist2.push({ role:"assistant", text:reply, ts:Date.now(), ctx });
        lsSet("bn_chat_history", hist2.slice(-60));

      }catch(e){
        renderChatMessage("assistant", "Network error: " + String(e));
      }
    }

    // ---- wire buttons ----
    $("btnStart").addEventListener("click", openTutor);
    $("btnResume").addEventListener("click", ()=>{
      const hist = lsGet("bn_chat_history", []);
      openTutor();
      toast(hist.length ? "Resumed" : "No session found", hist.length ? "Loaded last session." : "Start a session first.");
    });

    $("btnNewProject").addEventListener("click", ()=>{
      const name = prompt("New project name:", "New Project");
      if(!name) return;
      const s = getState();
      const id = "p_" + uid().slice(0,8);
      s.projects.unshift({ id, name:name.trim(), status:"DRAFT", updated:"now" });
      s.activeProjectId = id;
      setState(s);
      toast("Project created", `"${name.trim()}" is now active.`);
      syncContext();
    });

    $("btnAsk").addEventListener("click", ()=>{
      const q = $("quickPrompt").value.trim();
      if(!q){ toast("Need a prompt", "Type a question first."); return; }
      openTutor();
      $("tutorInput").value = q;
      $("quickPrompt").value = "";
      sendTutor();
    });

    $("btnUpload").addEventListener("click", ()=>{
      const inp = document.createElement("input");
      inp.type="file"; inp.multiple=true;
      inp.onchange = ()=>{
        const files = Array.from(inp.files||[]);
        if(!files.length) return;
        const s = getState();
        const proj = activeProject(s);
        const folder = activeFolder(s);
        files.forEach(f=>{
          s.files.unshift({
            id:"file_"+uid().slice(0,10),
            name:f.name, size:f.size, type:f.type||"file",
            projectId:proj?.id||null, folderId:folder?.id||null, added:Date.now()
          });
        });
        setState(s);
        toast("Files added", `Added ${files.length} file(s) locally. (Cloud sync next)`);
      };
      inp.click();
    });

    $("btnNewFolder").addEventListener("click", ()=>{
      const name = prompt("Folder name:", "New Folder");
      if(!name) return;
      const s = getState();
      const id = "f_" + uid().slice(0,8);
      s.folders.push({ id, name:name.trim() });
      s.activeFolderId = id;
      setState(s);
      toast("Folder created", `"${name.trim()}" is now active.`);
      syncContext();
    });

    $("btnOpenWorkspace").addEventListener("click", ()=>{
      toast("Workspace", "Projects / folders are tracked locally for now.");
    });

    $("rec1").addEventListener("click", ()=>{ openTutor(); $("tutorInput").value="Run a 12-minute micro-session. Start with 3 diagnostic questions."; $("tutorInput").focus(); });
    $("rec2").addEventListener("click", ()=>{ openTutor(); $("tutorInput").value="Give me an adaptive anatomy quiz."; $("tutorInput").focus(); });
    $("rec3").addEventListener("click", ()=>{ openTutor(); $("tutorInput").value="Build a weekly study plan. Ask my schedule first."; $("tutorInput").focus(); });

    // ---- set name/plan from state ----
    const s0 = getState();
    $("studentName").textContent = s0.studentName || "Student";
    $("planPill").textContent = "PLAN: " + (s0.plan || "PRO");

    // logout (dashboard-auth.js should implement; fallback just clear token)
    $("btnLogout").addEventListener("click", async ()=>{
      try{
        if(window.__SUPABASE_LOGOUT__) await window.__SUPABASE_LOGOUT__();
      }catch(_){}
      localStorage.removeItem("sb_access_token");
      toast("Logged out", "Sending you to /loginâ€¦");
      setTimeout(()=> window.location.href="/login", 600);
    });

<script type="module" src="/dashboard-auth.js"></script>
<script src="/script.js"></script>

</body>
</html>

